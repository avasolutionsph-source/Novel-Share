<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Twin Sisters | NovelShare</title>
  <link rel="icon" type="image/svg+xml" href="../assets/images/logo.svg">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <style>
    /* Novel Details Page Styles */
    .novel-content {
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }

    /* Novel Header Section */
    .novel-header {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 32px;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-medium);
      padding: 32px;
      margin-bottom: 24px;
    }

    .novel-cover {
      width: 220px;
      height: 320px;
      border-radius: var(--radius-md);
      background: var(--primary-gradient);
      box-shadow: var(--shadow-medium);
      position: relative;
      overflow: hidden;
    }

    .novel-cover::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(0,0,0,0.3) 100%);
    }

    .novel-info {
      display: flex;
      flex-direction: column;
    }

    .novel-badges {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .badge {
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-genre {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-status {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-status.ongoing {
      background: #fef3c7;
      color: #92400e;
    }

    .novel-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px;
      line-height: 1.2;
    }

    .novel-author {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .author-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .author-name {
      font-size: 0.9375rem;
      color: var(--text-secondary);
    }

    .author-name a {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
    }

    .author-name a:hover {
      text-decoration: underline;
    }

    .novel-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9375rem;
      color: var(--text-secondary);
    }

    .stat svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    .stat.rating svg {
      color: #f5b400;
      fill: #f5b400;
    }

    .stat strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .novel-description {
      font-size: 0.9375rem;
      line-height: 1.7;
      color: var(--text-secondary);
      margin-bottom: 24px;
      flex: 1;
    }

    .novel-description.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .read-more-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
      margin-bottom: 24px;
    }

    .novel-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-read {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      background: var(--primary-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .btn-read:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-primary);
    }

    .btn-read svg {
      width: 20px;
      height: 20px;
    }

    .btn-action {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 20px;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .btn-action:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #f0f4ff;
    }

    .btn-action.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .btn-action svg {
      width: 18px;
      height: 18px;
    }

    /* Floating Action Button */
    .fab-add {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary-gradient);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      transition: all var(--transition-normal);
      z-index: 100;
    }

    .fab-add:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
    }

    .fab-add svg {
      width: 24px;
      height: 24px;
      transition: transform var(--transition-normal);
    }

    .fab-add.in-library svg {
      transform: rotate(45deg);
    }

    .fab-add.in-library {
      background: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .fab-add.in-library:hover {
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    /* Novel Tabs Section */
    .novel-tabs-section {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
      overflow: hidden;
    }

    .novel-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      overflow-x: auto;
    }

    .novel-tab {
      padding: 16px 20px;
      background: none;
      border: none;
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      transition: color var(--transition-normal);
    }

    .novel-tab:hover {
      color: var(--text-primary);
    }

    .novel-tab.active {
      color: var(--primary);
      font-weight: 600;
    }

    .novel-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
      border-radius: var(--radius-full) var(--radius-full) 0 0;
    }

    .novel-tab-content {
      padding: 24px;
      display: none;
    }

    .novel-tab-content.active {
      display: block;
    }

    /* Chapters Tab */
    .chapters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chapters-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .chapters-sort {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chapters-sort label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .chapters-sort select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      background: var(--bg-primary);
      cursor: pointer;
    }

    .chapter-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chapter-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: var(--text-primary);
      transition: all var(--transition-normal);
    }

    .chapter-item:hover {
      background: #f0f4ff;
      transform: translateX(4px);
    }

    .chapter-number {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--primary);
      min-width: 60px;
    }

    .chapter-info {
      flex: 1;
    }

    .chapter-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px;
    }

    .chapter-meta {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .chapter-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chapter-read-badge {
      padding: 4px 10px;
      background: #d1fae5;
      color: #065f46;
      font-size: 0.6875rem;
      font-weight: 600;
      border-radius: var(--radius-full);
      text-transform: uppercase;
    }

    .chapter-new-badge {
      padding: 4px 10px;
      background: #dbeafe;
      color: #1e40af;
      font-size: 0.6875rem;
      font-weight: 600;
      border-radius: var(--radius-full);
      text-transform: uppercase;
    }

    /* Reviews Tab */
    .reviews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .reviews-summary {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .rating-big {
      font-size: 3rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
    }

    .rating-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stars {
      display: flex;
      gap: 4px;
    }

    .stars svg {
      width: 20px;
      height: 20px;
      color: #f5b400;
      fill: #f5b400;
    }

    .stars svg.empty {
      fill: none;
      color: var(--border);
    }

    .rating-count {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .btn-write-review {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--primary-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .btn-write-review:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-primary);
    }

    .btn-write-review svg {
      width: 18px;
      height: 18px;
    }

    .review-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .review-item {
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    .review-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .reviewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .reviewer-info {
      flex: 1;
    }

    .reviewer-name {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .review-date {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .review-rating {
      display: flex;
      gap: 2px;
    }

    .review-rating svg {
      width: 16px;
      height: 16px;
      color: #f5b400;
      fill: #f5b400;
    }

    .review-content {
      font-size: 0.9375rem;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .review-actions {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }

    .review-action {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      transition: color var(--transition-normal);
    }

    .review-action:hover {
      color: var(--primary);
    }

    .review-action svg {
      width: 16px;
      height: 16px;
    }

    /* Similar Novels Tab */
    .similar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }

    .similar-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      text-decoration: none;
      transition: all var(--transition-normal);
    }

    .similar-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-medium);
    }

    .similar-cover {
      height: 200px;
      background: var(--primary-gradient);
    }

    .similar-info {
      padding: 16px;
    }

    .similar-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .similar-author {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .similar-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .similar-rating svg {
      width: 14px;
      height: 14px;
      color: #f5b400;
      fill: #f5b400;
    }

    /* Write Review Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-normal);
    }

    .modal-close:hover {
      background: #f0f4ff;
    }

    .modal-close svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .rating-select {
      margin-bottom: 20px;
    }

    .rating-select label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .star-select {
      display: flex;
      gap: 8px;
    }

    .star-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      transition: transform var(--transition-fast);
    }

    .star-btn:hover {
      transform: scale(1.1);
    }

    .star-btn svg {
      width: 32px;
      height: 32px;
      color: var(--border);
      transition: color var(--transition-normal);
    }

    .star-btn.active svg {
      color: #f5b400;
      fill: #f5b400;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-group textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-family: inherit;
      resize: vertical;
      transition: all var(--transition-normal);
    }

    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(31, 111, 225, 0.1);
    }

    /* Notification & Profile Dropdowns */
    .notification-wrapper, .profile-wrapper {
      position: relative;
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: #ef4444;
      color: #fff;
      border-radius: 50%;
      font-size: 0.6875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-dropdown, .profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-heavy);
      display: none;
      z-index: 100;
      overflow: hidden;
    }

    .notification-dropdown { width: 320px; }
    .profile-dropdown { width: 200px; }

    .notification-dropdown.open, .profile-dropdown.open {
      display: block;
    }

    .notification-header, .profile-dropdown-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h4 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin: 0;
    }

    .notification-header button {
      font-size: 0.8125rem;
      color: var(--primary);
      background: none;
      border: none;
      cursor: pointer;
    }

    .notification-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background var(--transition-normal);
    }

    .notification-item:hover {
      background: var(--bg-secondary);
    }

    .notification-item.unread {
      background: #f0f7ff;
    }

    .notif-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .notif-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .profile-dropdown-header {
      text-align: center;
    }

    .profile-dropdown-header .avatar-lg {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.25rem;
      margin: 0 auto 8px;
    }

    .profile-dropdown-header .name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .profile-dropdown-header .email {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .profile-dropdown-menu {
      padding: 8px 0;
    }

    .profile-dropdown-menu a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 0.875rem;
      transition: background var(--transition-normal);
    }

    .profile-dropdown-menu a:hover {
      background: var(--bg-secondary);
    }

    .profile-dropdown-menu a svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    .profile-dropdown-menu .logout {
      color: #dc2626;
      border-top: 1px solid var(--border);
      margin-top: 8px;
      padding-top: 16px;
    }

    .profile-dropdown-menu .logout svg {
      color: #dc2626;
    }

    .profile { cursor: pointer; }

    /* Responsive */
    @media (max-width: 768px) {
      .novel-header {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .novel-cover {
        margin: 0 auto;
        width: 180px;
        height: 260px;
      }

      .novel-badges, .novel-author, .novel-stats, .novel-actions {
        justify-content: center;
      }

      .novel-title {
        font-size: 1.5rem;
      }

      .reviews-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      .similar-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .notification-dropdown {
        width: 280px;
        right: -100px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <header class="top-bar">
      <a href="home.html" class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <path d="M32 12c-4.8-3.3-10.4-4.4-16-4.4a6.6 6.6 0 0 0-6.6 6.6v28.2c0 1.1.9 2 2 2H18c4.7 0 9.3 1.5 13.2 4.2 3.9-2.7 8.5-4.2 13.2-4.2h6.6c1.1 0 2-.9 2-2V14.2A6.6 6.6 0 0 0 48 7.6C42.4 7.6 36.8 8.7 32 12Zm0 6.9c4.3-2.6 9.2-3.9 14.2-3.9 1.1 0 2 .9 2 2v24.1h-4.6c-4.5 0-8.9 1.1-12.8 3.2v-25.4Zm-4 25.4c-3.9-2.1-8.3-3.2-12.8-3.2H10.6V17c0-1.1.9-2 2-2 5 0 9.9 1.3 14.2 3.9v25.4Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="logo-text">
          <span class="logo-name">NovelShare</span>
          <span class="logo-tagline">READ • WRITE • SHARE</span>
        </div>
      </a>

      <nav class="nav-pills" aria-label="Main navigation">
        <a class="pill" href="library.html">
          <span class="pill-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
              <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15z"/>
            </svg>
          </span>
          Library
        </a>
        <a class="pill" href="browse.html">
          <span class="pill-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </span>
          Browse
        </a>
        <a class="pill" href="search.html">
          <span class="pill-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </span>
          Search
        </a>
        <a class="pill" href="author-dashboard.html">
          <span class="pill-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M12 19l7-7 3 3-7 7-3-3z"/>
              <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
              <path d="M2 2l7.586 7.586"/>
              <circle cx="11" cy="11" r="2"/>
            </svg>
          </span>
          Write
        </a>
      </nav>

      <div class="profile-actions">
        <div class="notification-wrapper">
          <button class="bell-btn" id="notificationBtn" aria-label="Notifications">
            <svg viewBox="0 0 24 24"><path d="M12 5.5A4.5 4.5 0 0 0 7.5 10v3.4l-.8 2.4h10.6l-.8-2.4V10A4.5 4.5 0 0 0 12 5.5z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M10 18.5a2 2 0 0 0 4 0" stroke-width="1.8" stroke="currentColor" fill="none"/></svg>
            <span class="notification-badge">2</span>
          </button>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h4>Notifications</h4>
              <button id="markAllRead">Mark all read</button>
            </div>
            <div class="notification-list">
              <div class="notification-item unread"><div class="notif-title">New chapter available!</div><div class="notif-time">5 minutes ago</div></div>
              <div class="notification-item unread"><div class="notif-title">Author replied to your review</div><div class="notif-time">1 hour ago</div></div>
            </div>
          </div>
        </div>

        <div class="profile-wrapper">
          <div class="profile" id="profileBtn">
            <div class="avatar">U</div>
            <span class="username">user</span>
          </div>
          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-dropdown-header">
              <div class="avatar-lg">U</div>
              <div class="name">User Name</div>
              <div class="email">user@example.com</div>
            </div>
            <div class="profile-dropdown-menu">
              <a href="profile.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>My Profile</a>
              <a href="library.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>My Works</a>
              <a href="login.html" class="logout"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>Log Out</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Novel Content -->
    <main class="novel-content">
      <!-- Novel Header -->
      <div class="novel-header">
        <div class="novel-cover"></div>

        <div class="novel-info">
          <div class="novel-badges">
            <span class="badge badge-genre">Historical Drama</span>
            <span class="badge badge-status ongoing">Ongoing</span>
          </div>

          <h1 class="novel-title">Twin Sisters</h1>

          <div class="novel-author">
            <div class="author-avatar">J</div>
            <span class="author-name">by <a href="profile.html">JaneWriter</a></span>
          </div>

          <div class="novel-stats">
            <div class="stat rating">
              <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              <strong>4.8</strong> (256 ratings)
            </div>
            <div class="stat">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <strong>45.2K</strong> reads
            </div>
            <div class="stat">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
              <strong>12</strong> chapters
            </div>
            <div class="stat">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
              <strong>1.2K</strong> in library
            </div>
          </div>

          <p class="novel-description collapsed" id="novelDescription">
            In the turbulent times of ancient China, two sisters from the prestigious Song family are forced to flee when their father is accused of a crime he didn't commit. Separated from everything they knew, Song Jin and Song Xiu must forge new identities and navigate a dangerous world where trust is a luxury they cannot afford.

            As they struggle to survive in a small village, secrets from their past threaten to surface. With officials searching for them and enemies lurking in the shadows, the sisters must rely on each other and the unexpected allies they meet along the way.

            This is a story of sisterhood, survival, and the unbreakable bonds that hold families together even in the darkest times. Will they be able to clear their family's name and return to their former glory, or will they be forced to live in hiding forever?
          </p>
          <button class="read-more-btn" id="readMoreBtn">Read more...</button>

          <div class="novel-actions">
            <button class="btn-read" onclick="window.location.href='reader.html'">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
              Start Reading
            </button>
            <button class="btn-action" id="addToLibraryBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
              Add to Library
            </button>
            <button class="btn-action" id="followAuthorBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              Follow Author
            </button>
            <button class="btn-action" id="shareBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
              Share
            </button>
          </div>
        </div>
      </div>

      <!-- Novel Tabs -->
      <div class="novel-tabs-section">
        <div class="novel-tabs">
          <button class="novel-tab active" data-tab="chapters">Chapters (12)</button>
          <button class="novel-tab" data-tab="reviews">Reviews (48)</button>
          <button class="novel-tab" data-tab="similar">Similar Novels</button>
        </div>

        <!-- Chapters Tab -->
        <div class="novel-tab-content active" id="tab-chapters">
          <div class="chapters-header">
            <h3>All Chapters</h3>
            <div class="chapters-sort">
              <label>Sort by:</label>
              <select id="chapterSort">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
              </select>
            </div>
          </div>

          <div class="chapter-list" id="chapterList">
            <a href="reader.html" class="chapter-item">
              <span class="chapter-number">Ch. 12</span>
              <div class="chapter-info">
                <h4 class="chapter-title">Sisters Forever</h4>
                <span class="chapter-meta">Dec 20, 2024 • 2,450 words</span>
              </div>
              <div class="chapter-status">
                <span class="chapter-new-badge">New</span>
              </div>
            </a>
            <a href="reader.html" class="chapter-item">
              <span class="chapter-number">Ch. 11</span>
              <div class="chapter-info">
                <h4 class="chapter-title">The Truth Emerges</h4>
                <span class="chapter-meta">Dec 18, 2024 • 2,180 words</span>
              </div>
            </a>
            <a href="reader.html" class="chapter-item">
              <span class="chapter-number">Ch. 10</span>
              <div class="chapter-info">
                <h4 class="chapter-title">Trust No One</h4>
                <span class="chapter-meta">Dec 15, 2024 • 1,950 words</span>
              </div>
            </a>
            <a href="reader.html" class="chapter-item">
              <span class="chapter-number">Ch. 9</span>
              <div class="chapter-info">
                <h4 class="chapter-title">A Dangerous Game</h4>
                <span class="chapter-meta">Dec 12, 2024 • 2,100 words</span>
              </div>
              <div class="chapter-status">
                <span class="chapter-read-badge">Read</span>
              </div>
            </a>
            <a href="reader.html" class="chapter-item">
              <span class="chapter-number">Ch. 8</span>
              <div class="chapter-info">
                <h4 class="chapter-title">The Search Begins</h4>
                <span class="chapter-meta">Dec 10, 2024 • 1,820 words</span>
              </div>
              <div class="chapter-status">
                <span class="chapter-read-badge">Read</span>
              </div>
            </a>
            <a href="reader.html" class="chapter-item">
              <span class="chapter-number">Ch. 3</span>
              <div class="chapter-info">
                <h4 class="chapter-title">The Escape</h4>
                <span class="chapter-meta">Dec 1, 2024 • 1,650 words</span>
              </div>
              <div class="chapter-status">
                <span class="chapter-read-badge">Read</span>
              </div>
            </a>
          </div>
        </div>

        <!-- Reviews Tab -->
        <div class="novel-tab-content" id="tab-reviews">
          <div class="reviews-header">
            <div class="reviews-summary">
              <span class="rating-big">4.8</span>
              <div class="rating-details">
                <div class="stars">
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24" class="empty"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </div>
                <span class="rating-count">Based on 256 ratings</span>
              </div>
            </div>
            <button class="btn-write-review" id="writeReviewBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
              Write a Review
            </button>
          </div>

          <div class="review-list">
            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-avatar">B</div>
                <div class="reviewer-info">
                  <div class="reviewer-name">BookLover22</div>
                  <div class="review-date">December 18, 2024</div>
                </div>
                <div class="review-rating">
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </div>
              </div>
              <p class="review-content">Absolutely captivating story! The author does an amazing job of bringing ancient China to life. The relationship between the two sisters is so touching and real. I can't wait for the next chapter!</p>
              <div class="review-actions">
                <button class="review-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg> Helpful (24)</button>
                <button class="review-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Reply</button>
              </div>
            </div>

            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-avatar">R</div>
                <div class="reviewer-info">
                  <div class="reviewer-name">HistoryFan99</div>
                  <div class="review-date">December 15, 2024</div>
                </div>
                <div class="review-rating">
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                  <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </div>
              </div>
              <p class="review-content">Great historical accuracy and attention to detail. The plot is engaging and the characters are well-developed. My only wish is that chapters were released more frequently!</p>
              <div class="review-actions">
                <button class="review-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg> Helpful (18)</button>
                <button class="review-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Reply</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Similar Novels Tab -->
        <div class="novel-tab-content" id="tab-similar">
          <div class="similar-grid">
            <a href="#" class="similar-card">
              <div class="similar-cover"></div>
              <div class="similar-info">
                <h4 class="similar-title">The Emperor's Concubine</h4>
                <p class="similar-author">by HistoryWriter</p>
                <div class="similar-rating"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.7</div>
              </div>
            </a>
            <a href="#" class="similar-card">
              <div class="similar-cover"></div>
              <div class="similar-info">
                <h4 class="similar-title">Dynasty of Dreams</h4>
                <p class="similar-author">by AncientTales</p>
                <div class="similar-rating"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.5</div>
              </div>
            </a>
            <a href="#" class="similar-card">
              <div class="similar-cover"></div>
              <div class="similar-info">
                <h4 class="similar-title">Silk Road Secrets</h4>
                <p class="similar-author">by TravelWriter</p>
                <div class="similar-rating"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.6</div>
              </div>
            </a>
            <a href="#" class="similar-card">
              <div class="similar-cover"></div>
              <div class="similar-info">
                <h4 class="similar-title">Palace Intrigue</h4>
                <p class="similar-author">by DramaQueen</p>
                <div class="similar-rating"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.4</div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <p>&copy; 2025 NovelShare. All Rights Reserved.</p>
      <div class="footer-links">
        <a href="#">Contact Us</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
      </div>
    </footer>
  </div>

  <!-- Write Review Modal -->
  <div class="modal-overlay" id="reviewModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Write a Review</h2>
        <button class="modal-close" id="closeReviewModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="rating-select">
          <label>Your Rating</label>
          <div class="star-select" id="starSelect">
            <button class="star-btn" data-rating="1"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></button>
            <button class="star-btn" data-rating="2"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></button>
            <button class="star-btn" data-rating="3"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></button>
            <button class="star-btn" data-rating="4"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></button>
            <button class="star-btn" data-rating="5"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></button>
          </div>
        </div>
        <div class="form-group">
          <label for="reviewText">Your Review</label>
          <textarea id="reviewText" placeholder="Share your thoughts about this novel..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelReview">Cancel</button>
        <button class="btn-primary" id="submitReview">Submit Review</button>
      </div>
    </div>
  </div>

  <!-- Floating Add Button -->
  <button class="fab-add" id="fabAddBtn" title="Add to Library">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <line x1="12" y1="5" x2="12" y2="19"/>
      <line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
  </button>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/supabase.js"></script>
  <script src="../assets/js/common.js"></script>
  <script>
    // Novel Data - will be populated from Supabase
    let novelData = {
      id: '',
      title: '',
      cover: '',
      author: '',
      authorId: ''
    };

    // Load novel from Supabase
    async function loadNovelFromSupabase() {
      const urlParams = new URLSearchParams(window.location.search);
      const novelId = urlParams.get('id');

      if (!novelId) {
        document.querySelector('.novel-content').innerHTML = '<div class="error-state" style="padding: 40px; text-align: center;"><h2>Novel not found</h2><p>Please go back to the <a href="home.html">home page</a>.</p></div>';
        return null;
      }

      try {
        const novel = await SupabaseDB.getNovelById(novelId);

        if (!novel) {
          document.querySelector('.novel-content').innerHTML = '<div class="error-state" style="padding: 40px; text-align: center;"><h2>Novel not found</h2><p>Please go back to the <a href="home.html">home page</a>.</p></div>';
          return null;
        }

        // Populate novelData
        novelData = {
          id: novel.id,
          title: novel.title,
          cover: novel.cover_image,
          author: novel.author,
          authorId: novel.author_id || 'unknown'
        };

        // Update page content
        document.title = `${novel.title} - NovelShare`;

        // Update novel header
        document.querySelector('.novel-title').textContent = novel.title;
        document.querySelector('.author-name').innerHTML = `by <a href="profile.html">${novel.author}</a>`;
        document.querySelector('.author-avatar').textContent = novel.author.charAt(0).toUpperCase();

        // Update cover
        const coverDiv = document.querySelector('.novel-cover');
        if (novel.cover_image) {
          coverDiv.style.backgroundImage = `url(${novel.cover_image})`;
        }

        // Update badges
        const badgesDiv = document.querySelector('.novel-badges');
        const genres = novel.genres || ['Fantasy'];
        const status = novel.status || 'ongoing';
        badgesDiv.innerHTML = `
          <span class="badge badge-genre">${genres[0]}</span>
          <span class="badge badge-status ${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
        `;

        // Update stats
        const statsDiv = document.querySelector('.novel-stats');
        const rating = novel.rating_avg ? novel.rating_avg.toFixed(1) : '0.0';
        const ratingCount = novel.rating_count || 0;
        const views = formatNumber(novel.view_count || 0);
        const chapters = novel.total_chapters || 0;

        statsDiv.innerHTML = `
          <div class="stat rating">
            <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <strong>${rating}</strong> (${ratingCount} ratings)
          </div>
          <div class="stat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <strong>${views}</strong> reads
          </div>
          <div class="stat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
            <strong>${chapters}</strong> chapters
          </div>
          <div class="stat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
            <strong>--</strong> in library
          </div>
        `;

        // Update description
        document.getElementById('novelDescription').textContent = novel.description || 'No description available.';

        // Update chapter tab count
        document.querySelector('[data-tab="chapters"]').textContent = `Chapters (${chapters})`;

        // Load chapters from Supabase
        await loadChapters(novel.id);

        return novel;
      } catch (error) {
        console.error('Failed to load novel:', error);
        document.querySelector('.novel-content').innerHTML = '<div class="error-state" style="padding: 40px; text-align: center;"><h2>Error loading novel</h2><p>Please try again or go back to the <a href="home.html">home page</a>.</p></div>';
        return null;
      }
    }

    // Load chapters from Supabase
    async function loadChapters(novelId) {
      const chapterList = document.getElementById('chapterList');

      try {
        const chapters = await SupabaseDB.getChapters(novelId);

        if (!chapters || chapters.length === 0) {
          chapterList.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-muted);">No chapters available yet.</div>';
          return;
        }

        // Sort newest first by default
        const sortedChapters = [...chapters].sort((a, b) => b.chapter_number - a.chapter_number);

        chapterList.innerHTML = sortedChapters.map(chapter => {
          const date = new Date(chapter.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const words = chapter.word_count ? `${chapter.word_count.toLocaleString()} words` : '';
          return `
            <a href="reader.html?novel=${novelId}&chapter=${chapter.chapter_number}" class="chapter-item" data-chapter="${chapter.chapter_number}">
              <span class="chapter-number">Ch. ${chapter.chapter_number}</span>
              <div class="chapter-info">
                <h4 class="chapter-title">${chapter.title}</h4>
                <span class="chapter-meta">${date}${words ? ' • ' + words : ''}</span>
              </div>
            </a>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load chapters:', error);
        chapterList.innerHTML = '<div class="error-state" style="padding: 20px; text-align: center;">Failed to load chapters.</div>';
      }
    }

    // Helper to format numbers
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    // Initialize page
    loadNovelFromSupabase().then(() => {
      // After loading, initialize UI features
      initializeUI();
    });

    function initializeUI() {
    // Tab switching
    const tabs = document.querySelectorAll('.novel-tab');
    const tabContents = document.querySelectorAll('.novel-tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // Read more description
    const description = document.getElementById('novelDescription');
    const readMoreBtn = document.getElementById('readMoreBtn');
    let isExpanded = false;

    readMoreBtn.addEventListener('click', () => {
      isExpanded = !isExpanded;
      description.classList.toggle('collapsed', !isExpanded);
      readMoreBtn.textContent = isExpanded ? 'Show less' : 'Read more...';
    });

    // Add to Library using LibrarySystem
    const addToLibraryBtn = document.getElementById('addToLibraryBtn');
    const fabAddBtn = document.getElementById('fabAddBtn');

    function updateLibraryUI() {
      const inLibrary = LibrarySystem.isInLibrary(novelData.id);
      if (inLibrary) {
        addToLibraryBtn.classList.add('active');
        addToLibraryBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> In Library`;
        // Update FAB
        fabAddBtn.classList.add('in-library');
        fabAddBtn.title = 'Remove from Library';
      } else {
        addToLibraryBtn.classList.remove('active');
        addToLibraryBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> Add to Library`;
        // Update FAB
        fabAddBtn.classList.remove('in-library');
        fabAddBtn.title = 'Add to Library';
      }
    }
    updateLibraryUI();

    addToLibraryBtn.addEventListener('click', async () => {
      // Check if user is in guest mode
      if (GuestMode.isGuestMode()) {
        showToast('Please sign up to add novels to your library');
        setTimeout(() => {
          window.location.href = 'signup.html';
        }, 1500);
        return;
      }

      const added = LibrarySystem.toggleLibrary(novelData.id, novelData);
      updateLibraryUI();
      showToast(added ? 'Added to your library' : 'Removed from library');

      // Sync to Supabase if logged in
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user) {
          if (added) {
            await SupabaseDB.addToLibrary(user.id, novelData.id);
          } else {
            await SupabaseDB.removeFromLibrary(user.id, novelData.id);
          }
        }
      } catch (error) {
        console.error('Error syncing library to Supabase:', error);
      }
    });

    // FAB button click handler
    fabAddBtn.addEventListener('click', async () => {
      // Check if user is in guest mode
      if (GuestMode.isGuestMode()) {
        showToast('Please sign up to add novels to your library');
        setTimeout(() => {
          window.location.href = 'signup.html';
        }, 1500);
        return;
      }

      const added = LibrarySystem.toggleLibrary(novelData.id, novelData);
      updateLibraryUI();
      showToast(added ? 'Added to your library' : 'Removed from library');

      // Sync to Supabase if logged in
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user) {
          if (added) {
            await SupabaseDB.addToLibrary(user.id, novelData.id);
          } else {
            await SupabaseDB.removeFromLibrary(user.id, novelData.id);
          }
        }
      } catch (error) {
        console.error('Error syncing library to Supabase:', error);
      }
    });

    // Follow Author using FollowingSystem
    const followAuthorBtn = document.getElementById('followAuthorBtn');

    function updateFollowUI() {
      const isFollowing = FollowingSystem.isFollowing(novelData.authorId);
      if (isFollowing) {
        followAuthorBtn.classList.add('active');
        followAuthorBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg> Following`;
      } else {
        followAuthorBtn.classList.remove('active');
        followAuthorBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg> Follow Author`;
      }
    }
    updateFollowUI();

    followAuthorBtn.addEventListener('click', async () => {
      // Check if user is in guest mode
      if (GuestMode.isGuestMode()) {
        showToast('Please sign up to follow authors');
        setTimeout(() => {
          window.location.href = 'signup.html';
        }, 1500);
        return;
      }

      const followed = FollowingSystem.toggleFollow(novelData.authorId, { name: novelData.author });
      updateFollowUI();
      showToast(followed ? `Now following ${novelData.author}` : `Unfollowed ${novelData.author}`);

      // Sync to Supabase if logged in
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user && novelData.authorId) {
          if (followed) {
            await SupabaseDB.followAuthor(user.id, novelData.authorId);
          } else {
            await SupabaseDB.unfollowAuthor(user.id, novelData.authorId);
          }
        }
      } catch (error) {
        console.error('Error syncing follow status to Supabase:', error);
      }
    });

    // Share
    document.getElementById('shareBtn').addEventListener('click', () => {
      if (navigator.share) {
        navigator.share({ title: `${novelData.title} - NovelShare`, url: window.location.href });
      } else {
        navigator.clipboard.writeText(window.location.href);
        showToast('Link copied to clipboard!');
      }
    });

    // Review Modal using RatingSystem
    const reviewModal = document.getElementById('reviewModal');
    const writeReviewBtn = document.getElementById('writeReviewBtn');
    const closeReviewModal = document.getElementById('closeReviewModal');
    const cancelReview = document.getElementById('cancelReview');
    const submitReview = document.getElementById('submitReview');
    const starBtns = document.querySelectorAll('#starSelect .star-btn');

    // Load existing rating if any
    const existingRating = RatingSystem.getRating(novelData.id);
    let selectedRating = existingRating ? existingRating.rating : 0;

    // Update star display
    function updateStarDisplay(rating) {
      starBtns.forEach((b, i) => b.classList.toggle('active', i < rating));
    }

    if (selectedRating > 0) {
      updateStarDisplay(selectedRating);
    }

    writeReviewBtn.addEventListener('click', () => {
      reviewModal.classList.add('open');
      updateStarDisplay(selectedRating);
      // Load existing review text if any
      if (existingRating && existingRating.review) {
        document.getElementById('reviewText').value = existingRating.review;
      }
    });

    closeReviewModal.addEventListener('click', () => reviewModal.classList.remove('open'));
    cancelReview.addEventListener('click', () => reviewModal.classList.remove('open'));
    reviewModal.addEventListener('click', (e) => { if (e.target === reviewModal) reviewModal.classList.remove('open'); });

    starBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedRating = parseInt(btn.dataset.rating);
        updateStarDisplay(selectedRating);
      });

      btn.addEventListener('mouseenter', () => {
        const rating = parseInt(btn.dataset.rating);
        updateStarDisplay(rating);
      });

      btn.addEventListener('mouseleave', () => {
        updateStarDisplay(selectedRating);
      });
    });

    submitReview.addEventListener('click', async () => {
      const reviewText = document.getElementById('reviewText').value.trim();
      if (selectedRating === 0) { showToast('Please select a rating'); return; }
      if (!reviewText) { showToast('Please write a review'); return; }

      // Save locally using RatingSystem
      RatingSystem.saveRating(novelData.id, selectedRating, reviewText);

      // Sync to Supabase if user is logged in
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user) {
          await SupabaseDB.rateNovel(user.id, novelData.id, selectedRating);
          console.log('Rating synced to Supabase');
        }
      } catch (error) {
        console.log('Could not sync rating to Supabase:', error);
        // Rating is still saved locally
      }

      reviewModal.classList.remove('open');
      showToast('Review submitted successfully!');
    });

    // Chapter sort
    document.getElementById('chapterSort').addEventListener('change', (e) => {
      const list = document.getElementById('chapterList');
      const items = Array.from(list.children);
      if (e.target.value === 'oldest') {
        items.reverse().forEach(item => list.appendChild(item));
      } else {
        items.reverse().forEach(item => list.appendChild(item));
      }
    });

    // Mark read chapters based on localStorage
    const readChapters = JSON.parse(localStorage.getItem(`read_chapters_${novelData.id}`) || '[]');
    document.querySelectorAll('.chapter-item').forEach(item => {
      const chapterNumText = item.querySelector('.chapter-number').textContent;
      const chapterNum = parseInt(chapterNumText.replace('Ch. ', ''));
      if (readChapters.includes(chapterNum)) {
        const statusDiv = item.querySelector('.chapter-status');
        if (!statusDiv) {
          const newStatus = document.createElement('div');
          newStatus.className = 'chapter-status';
          newStatus.innerHTML = '<span class="chapter-read-badge">Read</span>';
          item.appendChild(newStatus);
        }
      }
    });

    // Continue reading - check if there's a last read position
    const lastRead = ReadingHistory.getLastRead(novelData.id);
    if (lastRead) {
      const readBtn = document.querySelector('.btn-read');
      readBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg> Continue Reading`;
    }

    // Dropdowns
    const notifBtn = document.getElementById('notificationBtn');
    const notifDropdown = document.getElementById('notificationDropdown');
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');

    notifBtn.addEventListener('click', (e) => { e.stopPropagation(); notifDropdown.classList.toggle('open'); profileDropdown.classList.remove('open'); });
    profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('open'); notifDropdown.classList.remove('open'); });
    document.addEventListener('click', () => { notifDropdown.classList.remove('open'); profileDropdown.classList.remove('open'); });
    notifDropdown.addEventListener('click', (e) => e.stopPropagation());
    profileDropdown.addEventListener('click', (e) => e.stopPropagation());

    document.getElementById('markAllRead').addEventListener('click', () => {
      document.querySelectorAll('.notification-item.unread').forEach(item => item.classList.remove('unread'));
      document.querySelector('.notification-badge').style.display = 'none';
      showToast('All notifications marked as read');
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { reviewModal.classList.remove('open'); notifDropdown.classList.remove('open'); profileDropdown.classList.remove('open'); } });
    } // End of initializeUI function
  </script>
</body>
</html>
