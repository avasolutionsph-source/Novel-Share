<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reading: Twin Sisters - Chapter 3 | NovelShare</title>
  <link rel="icon" type="image/svg+xml" href="../assets/images/logo.svg">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" />
  <link rel="stylesheet" href="../assets/css/common.css" />
  <style>
    /* Reader Page Styles */
    body {
      background: var(--bg-secondary);
    }

    body.dark-mode {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16162a;
      --text-primary: #e4e4e7;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --border: #27273a;
      background: var(--bg-secondary);
    }

    body.sepia-mode {
      --bg-primary: #f4ecd8;
      --bg-secondary: #ebe3cf;
      --text-primary: #5c4b37;
      --text-secondary: #7a6a54;
      --text-muted: #9a8a74;
      --border: #d4c9b5;
      background: var(--bg-secondary);
    }

    .page {
      gap: 0;
      padding: 0;
    }

    /* Reader Header */
    .reader-header {
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .reader-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn-back {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
      text-decoration: none;
    }

    .btn-back:hover {
      background: #f0f4ff;
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-back svg {
      width: 18px;
      height: 18px;
    }

    .novel-info-header {
      display: flex;
      flex-direction: column;
    }

    .novel-title-header {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .chapter-title-header {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .reader-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .reader-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-normal);
    }

    .reader-btn:hover {
      background: #f0f4ff;
      border-color: var(--primary);
      color: var(--primary);
    }

    .reader-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .reader-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Reading Progress Bar */
    .reading-progress-bar {
      position: fixed;
      top: 65px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border);
      z-index: 99;
    }

    .reading-progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      width: 0%;
      transition: width 0.1s ease;
    }

    /* Reader Content */
    .reader-content {
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    .chapter-header {
      text-align: center;
      margin-bottom: 48px;
      padding-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }

    .chapter-number {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .chapter-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 16px;
      line-height: 1.3;
    }

    .chapter-meta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .chapter-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chapter-meta svg {
      width: 16px;
      height: 16px;
    }

    /* Chapter Content */
    .chapter-content {
      font-family: 'Merriweather', Georgia, serif;
      font-size: 1.125rem;
      line-height: 1.9;
      color: var(--text-primary);
    }

    .chapter-content p {
      margin-bottom: 1.5em;
      text-align: justify;
    }

    .chapter-content p:first-child::first-letter {
      font-size: 3.5em;
      float: left;
      line-height: 1;
      margin-right: 12px;
      margin-top: 4px;
      font-weight: 700;
      color: var(--primary);
    }

    /* Font size adjustments */
    body.font-small .chapter-content {
      font-size: 1rem;
    }

    body.font-large .chapter-content {
      font-size: 1.25rem;
    }

    body.font-xlarge .chapter-content {
      font-size: 1.375rem;
    }

    /* Chapter Navigation */
    .chapter-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 32px 0;
      margin-top: 48px;
      border-top: 1px solid var(--border);
      gap: 16px;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 24px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      text-decoration: none;
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-btn svg {
      width: 18px;
      height: 18px;
    }

    .chapter-list-btn {
      padding: 14px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .chapter-list-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Chapter End Section */
    .chapter-end {
      text-align: center;
      padding: 40px;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      margin-top: 48px;
    }

    .chapter-end h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .chapter-end p {
      color: var(--text-muted);
      margin: 0 0 24px;
    }

    .chapter-end-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-rate {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: var(--primary-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .btn-rate:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-primary);
    }

    .btn-rate svg {
      width: 18px;
      height: 18px;
    }

    /* Settings Panel */
    .settings-panel {
      position: fixed;
      top: 65px;
      right: -320px;
      width: 320px;
      height: calc(100vh - 65px);
      background: var(--bg-primary);
      border-left: 1px solid var(--border);
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      z-index: 100;
      transition: right var(--transition-slow);
      overflow-y: auto;
    }

    .settings-panel.open {
      right: 0;
    }

    .settings-panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-panel-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .settings-panel-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-normal);
    }

    .settings-panel-close:hover {
      background: #f0f4ff;
    }

    .settings-panel-close svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    .settings-section {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section h4 {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 0 16px;
    }

    /* Font Size Slider */
    .font-size-options {
      display: flex;
      gap: 8px;
    }

    .font-size-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .font-size-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .font-size-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    /* Theme Options */
    .theme-options {
      display: flex;
      gap: 12px;
    }

    .theme-btn {
      flex: 1;
      padding: 16px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      text-align: center;
      transition: all var(--transition-normal);
    }

    .theme-btn:hover {
      border-color: var(--primary);
    }

    .theme-btn.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(31, 111, 225, 0.2);
    }

    .theme-btn.light {
      background: #fff;
      color: #1b1f3b;
    }

    .theme-btn.dark {
      background: #1a1a2e;
      color: #e4e4e7;
    }

    .theme-btn.sepia {
      background: #f4ecd8;
      color: #5c4b37;
    }

    .theme-btn span {
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Chapter List Panel */
    .chapter-list-panel {
      position: fixed;
      top: 65px;
      left: -360px;
      width: 360px;
      height: calc(100vh - 65px);
      background: var(--bg-primary);
      border-right: 1px solid var(--border);
      box-shadow: 4px 0 20px rgba(0,0,0,0.1);
      z-index: 100;
      transition: left var(--transition-slow);
      overflow-y: auto;
    }

    .chapter-list-panel.open {
      left: 0;
    }

    .chapter-list-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--bg-primary);
    }

    .chapter-list-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .chapter-list {
      padding: 12px;
    }

    .chapter-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-normal);
      text-decoration: none;
      color: var(--text-primary);
    }

    .chapter-list-item:hover {
      background: var(--bg-secondary);
    }

    .chapter-list-item.current {
      background: #f0f4ff;
      border-left: 3px solid var(--primary);
    }

    .chapter-list-item.read {
      color: var(--text-muted);
    }

    .chapter-list-number {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--primary);
      min-width: 40px;
    }

    .chapter-list-title {
      flex: 1;
      font-size: 0.9375rem;
    }

    .chapter-list-check {
      color: #22c55e;
    }

    .chapter-list-check svg {
      width: 18px;
      height: 18px;
    }

    /* Rating Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 400px;
      text-align: center;
      padding: 32px;
    }

    .modal h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .modal p {
      color: var(--text-muted);
      margin: 0 0 24px;
    }

    .star-rating {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .star-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      transition: transform var(--transition-fast);
    }

    .star-btn:hover {
      transform: scale(1.1);
    }

    .star-btn svg {
      width: 40px;
      height: 40px;
      color: var(--border);
      transition: color var(--transition-normal);
    }

    .star-btn.active svg,
    .star-btn:hover svg {
      color: #f5b400;
      fill: #f5b400;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modal-actions button {
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-cancel {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-cancel:hover {
      background: #f0f4ff;
    }

    .btn-submit {
      background: var(--primary-gradient);
      color: #fff;
      border: none;
    }

    .btn-submit:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-primary);
    }

    /* Overlay when panels are open */
    .panel-overlay {
      position: fixed;
      top: 65px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 50;
      display: none;
    }

    .panel-overlay.active {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 28px;
      right: 32px;
      z-index: 1001;
    }

    /* Comments Section */
    .comments-section {
      margin-top: 48px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }

    .comments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .comments-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comments-title svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }

    .comments-count {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 4px 12px;
      border-radius: 20px;
    }

    .comment-form {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 24px;
    }

    .comment-form-login {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
    }

    .comment-form-login a {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
    }

    .comment-form-login a:hover {
      text-decoration: underline;
    }

    .comment-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9375rem;
      resize: vertical;
      transition: border-color var(--transition-normal);
    }

    .comment-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .comment-textarea::placeholder {
      color: var(--text-muted);
    }

    .comment-form-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .btn-comment {
      padding: 10px 24px;
      background: var(--primary-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .btn-comment:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-primary);
    }

    .btn-comment:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .comment-item {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px 20px;
    }

    .comment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .comment-author {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .comment-author-info {
      display: flex;
      flex-direction: column;
    }

    .comment-author-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9375rem;
    }

    .comment-date {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .comment-delete {
      padding: 6px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition-normal);
    }

    .comment-delete:hover {
      background: #fee2e2;
      color: #ef4444;
    }

    .comment-delete svg {
      width: 16px;
      height: 16px;
    }

    .comment-content {
      color: var(--text-primary);
      font-size: 0.9375rem;
      line-height: 1.6;
    }

    .comments-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .comments-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .comments-loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .load-more-comments {
      width: 100%;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
      margin-top: 16px;
    }

    .load-more-comments:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .reader-header {
        padding: 12px 16px;
      }

      .btn-back span {
        display: none;
      }

      .novel-info-header {
        display: none;
      }

      .reader-content {
        padding: 32px 16px 60px;
      }

      .chapter-title {
        font-size: 1.5rem;
      }

      .chapter-content {
        font-size: 1rem;
      }

      .chapter-nav {
        flex-direction: column;
      }

      .nav-btn {
        width: 100%;
        justify-content: center;
      }

      .settings-panel,
      .chapter-list-panel {
        width: 100%;
        right: -100%;
        left: -100%;
      }

      .settings-panel.open {
        right: 0;
      }

      .chapter-list-panel.open {
        left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Reader Header -->
    <header class="reader-header">
      <div class="reader-header-left">
        <a href="novel.html" class="btn-back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          <span>Back</span>
        </a>
        <div class="novel-info-header">
          <span class="novel-title-header">Twin Sisters</span>
          <span class="chapter-title-header">Chapter 3: The Escape</span>
        </div>
      </div>

      <div class="reader-header-right">
        <button class="reader-btn" id="chapterListBtn" title="Chapter List">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <line x1="3" y1="6" x2="3.01" y2="6"/>
            <line x1="3" y1="12" x2="3.01" y2="12"/>
            <line x1="3" y1="18" x2="3.01" y2="18"/>
          </svg>
        </button>
        <button class="reader-btn" id="bookmarkBtn" title="Bookmark">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
        <button class="reader-btn" id="downloadBtn" title="Download for Offline">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
        </button>
        <button class="reader-btn" id="settingsBtn" title="Reading Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1.08-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1.08 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Reading Progress Bar -->
    <div class="reading-progress-bar">
      <div class="reading-progress-fill" id="progressFill"></div>
    </div>

    <!-- Panel Overlay -->
    <div class="panel-overlay" id="panelOverlay"></div>

    <!-- Reader Content -->
    <main class="reader-content">
      <div class="chapter-header">
        <div class="chapter-number">Chapter 3</div>
        <h1 class="chapter-title">The Escape</h1>
        <div class="chapter-meta">
          <span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            8 min read
          </span>
          <span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            2,847 views
          </span>
          <span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Dec 15, 2024
          </span>
        </div>
      </div>

      <article class="chapter-content" id="chapterContent">
        <p>Huizhou Prefecture, She County. At night, the streets and alleys are quiet, and you can occasionally hear a few dogs barking. The moon hung low in the sky, casting long shadows across the cobblestone streets as Song Jin clutched her younger sister's hand tightly.</p>

        <p>A group of officials suddenly broke into the Song family's home. The leading official claimed that the medicinal materials sold by the Song family to the Northwest Army were inferior and had resulted in deaths. They were ordered to search the family's home and investigate the crime.</p>

        <p>"Oh no! There's a flood in the backyard!" someone shouted from the servants' quarters. The chaos spread like wildfire through the compound, with servants running in every direction, their lanterns creating dancing shadows on the walls.</p>

        <p>"Go put out the fire! The eldest and second young ladies are still in the house!" The head servant's voice cut through the commotion, but Song Jin knew better than to trust the confusion. This was their chance—their only chance.</p>

        <p>The Song family was in chaos and there were cries everywhere. Song Jin pulled her half-sister Song Xiu through the servant's corridor, a path she had memorized years ago during her childhood games. Now those innocent memories served a darker purpose.</p>

        <p>An ordinary horse-drawn carriage came out of the alley next to the Song residence and hurried towards the city gate. Inside the carriage, Song Jin hugged her half sister Song Xiu. Even though she was extremely frightened in her heart, her face remained calm. She had to be strong—for both of them.</p>

        <p>The old man Qin who was driving the car said, "Miss, when you get to Qinjiagou, tell everyone that you are from the next county and both your parents are dead." His weathered voice carried the weight of decades of loyalty to the Song family.</p>

        <p>Song Jin nodded, committing every word to memory. Their lives depended on the perfection of this lie. Song Xiu trembled beside her, and Jin wrapped her arm around her younger sister's shoulders.</p>

        <p>"Remember," Old Qin continued, his eyes fixed on the road ahead, "you are no longer daughters of the Song family. From this night forward, you are orphans seeking refuge. Trust no one with your true identity."</p>

        <p>The carriage wheels creaked against the worn path as they approached the city gate. Song Jin held her breath, watching through a gap in the curtain as the guards inspected a merchant's wagon ahead of them.</p>

        <p>"Papers," the guard demanded when they reached the checkpoint. Old Qin handed over the forged documents with steady hands, his demeanor that of a simple farmer taking his granddaughters to visit relatives.</p>

        <p>The seconds stretched into eternity. Song Jin could hear her own heartbeat, could feel Song Xiu's fingers digging into her arm. Finally, the guard waved them through with barely a second glance.</p>

        <p>As the city walls disappeared behind them and the open road stretched ahead, Song Jin allowed herself one moment of grief for the life she was leaving behind. But only one moment. Survival demanded focus, demanded strength.</p>

        <p>The dawn was breaking when they finally stopped at a small inn on the outskirts of Qinjiagou. Old Qin helped them down from the carriage, pressing a small pouch of coins into Song Jin's hands.</p>

        <p>"This is all I can give you," he said, his eyes glistening in the early morning light. "Your father was a good man. Remember that, no matter what they say about him."</p>

        <p>Song Jin watched as the carriage disappeared down the road, taking with it the last connection to her former life. She squeezed Song Xiu's hand and turned toward the village. A new chapter was beginning, written in uncertainty and fear, but also in the unbreakable bond between two sisters.</p>
      </article>

      <!-- Chapter End Section -->
      <div class="chapter-end">
        <h3>End of Chapter 3</h3>
        <p>Did you enjoy this chapter? Let the author know!</p>
        <div class="chapter-end-actions">
          <button class="btn-rate" id="rateChapterBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            Rate This Chapter
          </button>
          <button class="nav-btn" id="addToLibraryBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            Add to Library
          </button>
        </div>
      </div>

      <!-- Chapter Navigation -->
      <nav class="chapter-nav">
        <button class="nav-btn" id="prevChapterBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Previous Chapter
        </button>
        <button class="chapter-list-btn" id="chapterListBtn2">
          Chapter 3 of 12
        </button>
        <button class="nav-btn" id="nextChapterBtn">
          Next Chapter
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </nav>

      <!-- Comments Section -->
      <section class="comments-section" id="commentsSection">
        <div class="comments-header">
          <h2 class="comments-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Comments
          </h2>
          <span class="comments-count" id="commentsCount">0 comments</span>
        </div>

        <!-- Comment Form -->
        <div class="comment-form" id="commentForm">
          <div class="comment-form-login" id="commentLoginPrompt">
            <a href="login.html">Sign in</a> to leave a comment
          </div>
          <div id="commentFormContent" style="display: none;">
            <textarea class="comment-textarea" id="commentInput" placeholder="Share your thoughts about this chapter..."></textarea>
            <div class="comment-form-actions">
              <button class="btn-comment" id="submitComment">Post Comment</button>
            </div>
          </div>
        </div>

        <!-- Comments List -->
        <div class="comments-list" id="commentsList">
          <div class="comments-loading">Loading comments...</div>
        </div>
      </section>
    </main>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-panel-header">
        <h3>Reading Settings</h3>
        <button class="settings-panel-close" id="closeSettings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="settings-section">
        <h4>Font Size</h4>
        <div class="font-size-options">
          <button class="font-size-btn" data-size="small">A-</button>
          <button class="font-size-btn active" data-size="medium">A</button>
          <button class="font-size-btn" data-size="large">A+</button>
          <button class="font-size-btn" data-size="xlarge">A++</button>
        </div>
      </div>

      <div class="settings-section">
        <h4>Theme</h4>
        <div class="theme-options">
          <button class="theme-btn light active" data-theme="light">
            <span>Light</span>
          </button>
          <button class="theme-btn dark" data-theme="dark">
            <span>Dark</span>
          </button>
          <button class="theme-btn sepia" data-theme="sepia">
            <span>Sepia</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Chapter List Panel -->
    <div class="chapter-list-panel" id="chapterListPanel">
      <div class="chapter-list-header">
        <h3>Chapters</h3>
        <button class="settings-panel-close" id="closeChapterList">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="chapter-list">
        <a href="#" class="chapter-list-item read">
          <span class="chapter-list-number">1</span>
          <span class="chapter-list-title">The Song Family</span>
          <span class="chapter-list-check">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </span>
        </a>
        <a href="#" class="chapter-list-item read">
          <span class="chapter-list-number">2</span>
          <span class="chapter-list-title">Dark Clouds Gather</span>
          <span class="chapter-list-check">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </span>
        </a>
        <a href="#" class="chapter-list-item current">
          <span class="chapter-list-number">3</span>
          <span class="chapter-list-title">The Escape</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">4</span>
          <span class="chapter-list-title">A New Identity</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">5</span>
          <span class="chapter-list-title">Village Life</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">6</span>
          <span class="chapter-list-title">Unexpected Encounter</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">7</span>
          <span class="chapter-list-title">Secrets Revealed</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">8</span>
          <span class="chapter-list-title">The Search Begins</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">9</span>
          <span class="chapter-list-title">A Dangerous Game</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">10</span>
          <span class="chapter-list-title">Trust No One</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">11</span>
          <span class="chapter-list-title">The Truth Emerges</span>
        </a>
        <a href="#" class="chapter-list-item">
          <span class="chapter-list-number">12</span>
          <span class="chapter-list-title">Sisters Forever</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal-overlay" id="ratingModal">
    <div class="modal">
      <h2>Rate This Chapter</h2>
      <p>How would you rate "The Escape"?</p>
      <div class="star-rating" id="starRating">
        <button class="star-btn" data-rating="1">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
        <button class="star-btn" data-rating="2">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
        <button class="star-btn" data-rating="3">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
        <button class="star-btn" data-rating="4">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
        <button class="star-btn" data-rating="5">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancelRating">Cancel</button>
        <button class="btn-submit" id="submitRating">Submit Rating</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/common.js"></script>
  <script src="../assets/js/supabase.js"></script>
  <script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const novelId = urlParams.get('id') || urlParams.get('novelId');
    const chapterNumber = parseInt(urlParams.get('chapter')) || 1;

    // Novel/Chapter Data (will be populated from Supabase)
    let novelData = {
      id: novelId,
      title: 'Loading...',
      cover: '',
      author: 'Loading...',
      authorId: null
    };
    let chapterData = {
      id: chapterNumber,
      title: 'Loading...',
      totalChapters: 1,
      content: ''
    };
    let allChapters = [];

    // Load novel and chapter data from Supabase
    async function loadChapterFromSupabase() {
      if (!novelId) {
        showToast('No novel specified');
        return false;
      }

      try {
        // Fetch novel details
        const { data: novel, error: novelError } = await window.supabaseClient
          .from('novels')
          .select('*')
          .eq('id', novelId)
          .single();

        if (novelError) throw novelError;

        if (novel) {
          novelData = {
            id: novel.id,
            title: novel.title,
            cover: novel.cover_image,
            author: novel.author,
            authorId: novel.author_id
          };
          chapterData.totalChapters = novel.total_chapters || 1;

          // Update header with novel info
          document.querySelector('.novel-title-header').textContent = novel.title;
          document.querySelector('.btn-back').href = `novel.html?id=${novelId}`;
          document.title = `Reading: ${novel.title} | NovelShare`;
        }

        // Fetch all chapters for this novel
        const { data: chapters, error: chaptersError } = await window.supabaseClient
          .from('chapters')
          .select('*')
          .eq('novel_id', novelId)
          .order('chapter_number', { ascending: true });

        if (chaptersError) throw chaptersError;

        allChapters = chapters || [];
        chapterData.totalChapters = allChapters.length || novel?.total_chapters || 1;

        // Find the specific chapter
        const chapter = allChapters.find(c => c.chapter_number === chapterNumber);

        if (chapter) {
          chapterData = {
            id: chapter.chapter_number,
            dbId: chapter.id,
            title: chapter.title,
            content: chapter.content,
            totalChapters: allChapters.length,
            wordCount: chapter.word_count || 0
          };

          // Update chapter display
          updateChapterDisplay();
          updateChapterList();
          return true;
        } else {
          // No chapter found - show demo content if no chapters exist
          if (allChapters.length === 0) {
            showToast('No chapters available yet');
            document.getElementById('chapterContent').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">This novel has no chapters yet. Check back later!</p>';
          } else {
            showToast(`Chapter ${chapterNumber} not found`);
          }
          return false;
        }

      } catch (error) {
        console.error('Error loading chapter:', error);
        showToast('Failed to load chapter');
        return false;
      }
    }

    // Update the chapter display with fetched data
    function updateChapterDisplay() {
      document.querySelector('.chapter-number').textContent = `Chapter ${chapterData.id}`;
      document.querySelector('.chapter-title').textContent = chapterData.title;
      document.querySelector('.chapter-title-header').textContent = `Chapter ${chapterData.id}: ${chapterData.title}`;
      document.getElementById('chapterListBtn2').textContent = `Chapter ${chapterData.id} of ${chapterData.totalChapters}`;

      // Update reading time estimate (roughly 200 words per minute)
      const wordCount = chapterData.wordCount || (chapterData.content ? chapterData.content.split(/\s+/).length : 0);
      const readingTime = Math.ceil(wordCount / 200);
      const readingTimeElement = document.querySelector('.chapter-meta span:first-child');
      if (readingTimeElement) {
        readingTimeElement.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          ${readingTime} min read
        `;
      }

      // Update chapter content
      const chapterContent = document.getElementById('chapterContent');
      if (chapterData.content) {
        // Format content - wrap in paragraphs if not already HTML
        let formattedContent = chapterData.content;
        if (!formattedContent.includes('<p>')) {
          formattedContent = formattedContent
            .split('\n\n')
            .filter(p => p.trim())
            .map(p => `<p>${p.trim()}</p>`)
            .join('');
        }
        chapterContent.innerHTML = formattedContent;
      }

      // Update nav button states
      updateNavButtonStates();
    }

    // Update the chapter list panel
    function updateChapterList() {
      const chapterListContainer = document.querySelector('.chapter-list');
      if (!chapterListContainer || allChapters.length === 0) return;

      const readChapters = JSON.parse(localStorage.getItem(`read_chapters_${novelData.id}`) || '[]');

      const chaptersHTML = allChapters.map(chapter => {
        const isRead = readChapters.includes(chapter.chapter_number);
        const isCurrent = chapter.chapter_number === chapterData.id;

        return `
          <a href="reader.html?id=${novelId}&chapter=${chapter.chapter_number}"
             class="chapter-list-item ${isCurrent ? 'current' : ''} ${isRead ? 'read' : ''}">
            <span class="chapter-list-number">${chapter.chapter_number}</span>
            <span class="chapter-list-title">${chapter.title}</span>
            ${isRead ? `<span class="chapter-list-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </span>` : ''}
          </a>
        `;
      }).join('');

      chapterListContainer.innerHTML = chaptersHTML;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      const loaded = await loadChapterFromSupabase();
      if (!loaded) {
        // Fall back to demo content if available
        console.log('Using fallback/demo content');
      }
    });

    // Mock chapter titles for demo (fallback)
    const chapterTitles = {
      1: 'The Beginning',
      2: 'A New Discovery',
      3: 'The Escape',
      4: 'Unexpected Allies',
      5: 'The Journey North',
      6: 'Secrets Revealed',
      7: 'The Confrontation',
      8: 'A Narrow Escape',
      9: 'New Horizons',
      10: 'The Truth',
      11: 'Final Preparations',
      12: 'The End'
    };

    // Mock chapter content for demo
    const chapterContents = {
      1: `<p>The morning sun cast long shadows across the ancient cobblestone streets of the old city. Sarah stood at her window, watching the world wake up below. Today would be different, she could feel it in her bones.</p>
          <p>Her twin sister Emma was already downstairs, the familiar sounds of breakfast preparation drifting up through the floorboards. They had lived in this house their entire lives, but something felt different today.</p>
          <p>"Sarah! Breakfast is ready!" Emma's voice echoed through the hallway.</p>
          <p>Little did they know that this ordinary morning would be the beginning of an extraordinary journey that would change their lives forever.</p>`,
      2: `<p>The letter arrived without warning. It was tucked between the usual bills and advertisements, its aged envelope standing out like a beacon of mystery.</p>
          <p>"What's this?" Emma asked, turning the envelope over in her hands. There was no return address, only their names written in elegant, flowing script.</p>
          <p>Sarah leaned closer, her heart quickening. "Open it."</p>
          <p>Inside was a single page, yellowed with age, bearing words that would unravel everything they thought they knew about their family.</p>`,
      3: `<p>The night was dark and foreboding as Sarah and Emma made their way through the narrow alleyways of the old quarter. Behind them, the sound of pursuit grew ever closer.</p>
          <p>"This way," Sarah whispered urgently, pulling her sister into a shadowed doorway. They pressed themselves against the cold stone wall, barely breathing as footsteps echoed past.</p>
          <p>The letter had led them here, to this ancient part of the city where secrets had been buried for generations. But they weren't the only ones seeking answers.</p>
          <p>"We need to find the old church," Emma said once the footsteps faded. "That's where the next clue is hidden."</p>
          <p>They moved through the darkness like ghosts, two sisters bound by blood and united by a mystery that stretched back through time itself.</p>`,
      4: `<p>The stranger appeared from nowhere, stepping out of the shadows with hands raised in peace. "Don't be afraid," he said softly. "I'm here to help."</p>
          <p>Sarah positioned herself protectively in front of Emma. "Who are you?"</p>
          <p>"My name is Marcus. I knew your grandmother." His eyes held a weight of years and secrets. "She asked me to watch over you, should this day ever come."</p>
          <p>The twins exchanged glances. Could they trust this mysterious man? They had no choice but to find out.</p>`,
      5: `<p>The train rattled northward through landscapes of increasing wildness. Mountains rose in the distance, their peaks shrouded in mist and mystery.</p>
          <p>Marcus had explained everything—the ancient order, the family legacy, the reason they had been kept in the dark for so long. It was almost too much to believe.</p>
          <p>"The sanctuary is three days journey from here," he said, studying an old map. "We'll need to be careful. There are those who would stop us."</p>
          <p>Sarah watched the scenery blur past the window. Somewhere ahead lay answers, and perhaps, the truth about who they really were.</p>`,
      6: `<p>The sanctuary was not what they expected. Hidden within a mountain valley, it was a place of breathtaking beauty and profound peace.</p>
          <p>The Elder welcomed them with knowing eyes. "We have waited long for this moment," she said. "The daughters of the prophecy have finally arrived."</p>
          <p>"Prophecy?" Emma's voice trembled. "What prophecy?"</p>
          <p>What followed was a revelation that shattered everything they thought they knew about themselves, their family, and the very nature of the world.</p>`,
      7: `<p>They found them at midnight—the pursuers who had been tracking them since the beginning. The sanctuary's ancient protections could only hold for so long.</p>
          <p>"Give us the girls," demanded the leader, his voice echoing across the moonlit courtyard. "They don't belong with you."</p>
          <p>But Sarah and Emma were no longer the frightened twins who had fled the city. They had learned things, discovered powers within themselves that had lain dormant for generations.</p>
          <p>"We belong wherever we choose," Sarah replied, her voice steady despite the pounding of her heart.</p>`,
      8: `<p>The escape route led through ancient tunnels beneath the sanctuary, paths that hadn't been walked in centuries. Marcus led the way with a flickering torch.</p>
          <p>"They won't follow us here," he assured them. "These passages are sacred, warded against those with ill intent."</p>
          <p>But the twins could feel it—something waiting in the darkness ahead. Something that had been sleeping for a very long time.</p>
          <p>They pressed on regardless. There was no turning back now.</p>`,
      9: `<p>They emerged into a world transformed. The sun was rising over a landscape they had never seen before—vast plains stretching to distant horizons, dotted with ancient ruins that spoke of civilizations long forgotten.</p>
          <p>"Where are we?" Emma breathed.</p>
          <p>"Home," Marcus replied simply. "The true home of your ancestors. Welcome to the Old World."</p>
          <p>Sarah reached for her sister's hand. Whatever challenges lay ahead, they would face them together.</p>`,
      10: `<p>The archives contained everything—records stretching back millennia, documenting the rise and fall of empires, the birth and death of gods, and at the center of it all, their family.</p>
          <p>"We were never ordinary," Sarah said, running her fingers over an ancient genealogy. "We were never meant to be hidden away."</p>
          <p>Emma nodded, tears streaming down her face. "Mother knew. Father knew. They sacrificed everything to protect us."</p>
          <p>The truth was beautiful and terrible all at once. But it was their truth, and they would carry it forward.</p>`,
      11: `<p>The final confrontation was approaching. They could feel it in the very air around them, a gathering storm of ancient forces.</p>
          <p>"Are you ready?" Marcus asked, watching them complete the ritual preparations.</p>
          <p>The twins looked at each other, communicating in that silent way only they could understand. They had come so far, learned so much, grown in ways they never imagined possible.</p>
          <p>"We're ready," they said in unison.</p>`,
      12: `<p>In the end, it wasn't about power or prophecy. It was about choice—the choice to embrace who they were, to accept their heritage while forging their own path.</p>
          <p>The enemy was defeated not through violence, but through understanding. The ancient conflict that had driven their family into hiding was finally, irrevocably ended.</p>
          <p>Sarah and Emma stood together on the balcony of their ancestral home, watching the sun set over a world at peace.</p>
          <p>"What now?" Emma asked.</p>
          <p>Sarah smiled. "Now we live. Really live, for the first time."</p>
          <p>And so begins a new chapter—not just in their story, but in the story of the world itself.</p>
          <p class="chapter-end" style="text-align: center; margin-top: 40px; font-style: italic; color: var(--text-muted);">~ The End ~</p>`
    };

    // Reading Progress
    const progressFill = document.getElementById('progressFill');
    const chapterContent = document.getElementById('chapterContent');

    function updateProgress() {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = (scrollTop / docHeight) * 100;
      progressFill.style.width = Math.min(progress, 100) + '%';

      // Save reading position using debounce
      clearTimeout(window.savePositionTimeout);
      window.savePositionTimeout = setTimeout(() => {
        localStorage.setItem(`reading_position_${novelData.id}_${chapterData.id}`, scrollTop);

        // Update library progress if in library
        if (LibrarySystem.isInLibrary(novelData.id)) {
          LibrarySystem.updateProgress(novelData.id, Math.round(progress), chapterData.id);
        }
      }, 300);
    }

    window.addEventListener('scroll', updateProgress);

    // Restore reading position
    const savedPosition = localStorage.getItem(`reading_position_${novelData.id}_${chapterData.id}`);
    if (savedPosition) {
      window.scrollTo(0, parseInt(savedPosition));
    }

    // Add to reading history (local + Supabase)
    ReadingHistory.addToHistory(novelData.id, chapterData.id, {
      title: novelData.title,
      chapterTitle: chapterData.title,
      cover: novelData.cover
    });

    // Sync reading history to Supabase if logged in
    async function syncReadingHistoryToSupabase() {
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user && novelData.id && chapterData.dbId) {
          await SupabaseDB.addToHistory(
            user.id,
            novelData.id,
            chapterData.dbId,
            `Chapter ${chapterData.id}: ${chapterData.title}`
          );
        }
      } catch (error) {
        console.error('Failed to sync reading history:', error);
      }
    }
    // Delay sync to ensure data is loaded
    setTimeout(syncReadingHistoryToSupabase, 1000);

    // Settings Panel
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettings = document.getElementById('closeSettings');
    const panelOverlay = document.getElementById('panelOverlay');

    settingsBtn.addEventListener('click', () => {
      settingsPanel.classList.add('open');
      panelOverlay.classList.add('active');
    });

    closeSettings.addEventListener('click', () => {
      settingsPanel.classList.remove('open');
      panelOverlay.classList.remove('active');
    });

    // Chapter List Panel
    const chapterListBtn = document.getElementById('chapterListBtn');
    const chapterListBtn2 = document.getElementById('chapterListBtn2');
    const chapterListPanel = document.getElementById('chapterListPanel');
    const closeChapterList = document.getElementById('closeChapterList');

    [chapterListBtn, chapterListBtn2].forEach(btn => {
      btn.addEventListener('click', () => {
        chapterListPanel.classList.add('open');
        panelOverlay.classList.add('active');
      });
    });

    closeChapterList.addEventListener('click', () => {
      chapterListPanel.classList.remove('open');
      panelOverlay.classList.remove('active');
    });

    panelOverlay.addEventListener('click', () => {
      settingsPanel.classList.remove('open');
      chapterListPanel.classList.remove('open');
      panelOverlay.classList.remove('active');
    });

    // Font Size
    const fontSizeBtns = document.querySelectorAll('.font-size-btn');
    fontSizeBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        fontSizeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.body.classList.remove('font-small', 'font-large', 'font-xlarge');
        const size = btn.dataset.size;
        if (size !== 'medium') {
          document.body.classList.add('font-' + size);
        }

        localStorage.setItem('reader_font_size', size);

        // Sync to Supabase if logged in
        try {
          const { data: { user } } = await window.supabaseClient.auth.getUser();
          if (user) {
            const currentTheme = localStorage.getItem('reader_theme') || 'light';
            await SupabaseDB.savePreferences(user.id, { fontSize: size, theme: currentTheme });
          }
        } catch (error) {
          console.error('Error syncing preferences to Supabase:', error);
        }
      });
    });

    // Theme
    const themeBtns = document.querySelectorAll('.theme-btn');
    themeBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        themeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.body.classList.remove('dark-mode', 'sepia-mode');
        const theme = btn.dataset.theme;
        if (theme === 'dark') {
          document.body.classList.add('dark-mode');
        } else if (theme === 'sepia') {
          document.body.classList.add('sepia-mode');
        }

        localStorage.setItem('reader_theme', theme);

        // Sync to Supabase if logged in
        try {
          const { data: { user } } = await window.supabaseClient.auth.getUser();
          if (user) {
            const currentFontSize = localStorage.getItem('reader_font_size') || 'medium';
            await SupabaseDB.savePreferences(user.id, { fontSize: currentFontSize, theme: theme });
          }
        } catch (error) {
          console.error('Error syncing preferences to Supabase:', error);
        }
      });
    });

    // Load saved preferences - try Supabase first, then localStorage
    async function loadReaderPreferences() {
      let fontSize = localStorage.getItem('reader_font_size');
      let theme = localStorage.getItem('reader_theme');

      // Try to load from Supabase if logged in
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user) {
          const prefs = await SupabaseDB.getPreferences(user.id);
          if (prefs) {
            fontSize = prefs.reader_font_size || fontSize;
            theme = prefs.reader_theme || theme;
            // Update localStorage to keep in sync
            if (prefs.reader_font_size) localStorage.setItem('reader_font_size', prefs.reader_font_size);
            if (prefs.reader_theme) localStorage.setItem('reader_theme', prefs.reader_theme);
          }
        }
      } catch (error) {
        console.error('Error loading preferences from Supabase:', error);
      }

      // Apply font size
      if (fontSize) {
        fontSizeBtns.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-size="${fontSize}"]`)?.classList.add('active');
        if (fontSize !== 'medium') {
          document.body.classList.add('font-' + fontSize);
        }
      }

      // Apply theme
      if (theme) {
        themeBtns.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-theme="${theme}"]`)?.classList.add('active');
        if (theme === 'dark') {
          document.body.classList.add('dark-mode');
        } else if (theme === 'sepia') {
          document.body.classList.add('sepia-mode');
        }
      }
    }

    // Load preferences on page load
    loadReaderPreferences();

    // Bookmark using BookmarkSystem
    const bookmarkBtn = document.getElementById('bookmarkBtn');

    function updateBookmarkUI() {
      const isBookmarked = BookmarkSystem.isBookmarked(novelData.id, chapterData.id);
      if (isBookmarked) {
        bookmarkBtn.classList.add('active');
        bookmarkBtn.querySelector('svg').setAttribute('fill', 'currentColor');
      } else {
        bookmarkBtn.classList.remove('active');
        bookmarkBtn.querySelector('svg').setAttribute('fill', 'none');
      }
    }

    updateBookmarkUI();

    bookmarkBtn.addEventListener('click', async () => {
      const isBookmarked = BookmarkSystem.isBookmarked(novelData.id, chapterData.id);

      if (isBookmarked) {
        // Remove all bookmarks for this chapter
        const bookmarks = BookmarkSystem.getChapterBookmarks(novelData.id, chapterData.id);
        bookmarks.forEach(b => BookmarkSystem.removeBookmark(b.id));

        // Also remove from Supabase if logged in
        try {
          const { data: { user } } = await window.supabaseClient.auth.getUser();
          if (user && chapterData.dbId) {
            await SupabaseDB.removeBookmarkByChapter(user.id, novelData.id, chapterData.dbId);
          }
        } catch (error) {
          console.error('Error removing bookmark from Supabase:', error);
        }

        showToast('Bookmark removed');
      } else {
        // Add bookmark at current position
        const scrollPosition = window.scrollY;
        const note = `Bookmarked at ${new Date().toLocaleString()}`;
        BookmarkSystem.addBookmark(novelData.id, chapterData.id, scrollPosition, note);

        // Also save to Supabase if logged in
        try {
          const { data: { user } } = await window.supabaseClient.auth.getUser();
          if (user && chapterData.dbId) {
            await SupabaseDB.addBookmark(user.id, novelData.id, chapterData.dbId, note);
          }
        } catch (error) {
          console.error('Error saving bookmark to Supabase:', error);
        }

        showToast('Bookmark added');
      }

      updateBookmarkUI();
    });

    // Download for Offline Reading
    document.getElementById('downloadBtn').addEventListener('click', () => {
      // Store chapter content for offline access
      const offlineChapters = JSON.parse(localStorage.getItem('novelshare_offline') || '{}');
      const chapterKey = `${novelData.id}_${chapterData.id}`;

      if (offlineChapters[chapterKey]) {
        delete offlineChapters[chapterKey];
        localStorage.setItem('novelshare_offline', JSON.stringify(offlineChapters));
        showToast('Removed from offline reading');
      } else {
        offlineChapters[chapterKey] = {
          novelId: novelData.id,
          novelTitle: novelData.title,
          chapterId: chapterData.id,
          chapterTitle: chapterData.title,
          content: chapterContent.innerHTML,
          downloadedAt: Date.now()
        };
        localStorage.setItem('novelshare_offline', JSON.stringify(offlineChapters));
        showToast('Chapter saved for offline reading');
      }
    });

    // Rating Modal using RatingSystem
    const ratingModal = document.getElementById('ratingModal');
    const rateChapterBtn = document.getElementById('rateChapterBtn');
    const cancelRating = document.getElementById('cancelRating');
    const submitRating = document.getElementById('submitRating');
    const starBtns = document.querySelectorAll('.star-btn');

    // Load existing rating
    const existingRating = RatingSystem.getRating(`${novelData.id}_chapter_${chapterData.id}`);
    let currentRating = existingRating ? existingRating.rating : 0;

    // Update star display for existing rating
    function updateStarDisplay(rating) {
      starBtns.forEach((b, index) => {
        if (index < rating) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
    }

    if (currentRating > 0) {
      updateStarDisplay(currentRating);
    }

    rateChapterBtn.addEventListener('click', () => {
      ratingModal.classList.add('open');
      // Show existing rating in modal
      updateStarDisplay(currentRating);
    });

    cancelRating.addEventListener('click', () => {
      ratingModal.classList.remove('open');
    });

    ratingModal.addEventListener('click', (e) => {
      if (e.target === ratingModal) {
        ratingModal.classList.remove('open');
      }
    });

    starBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentRating = parseInt(btn.dataset.rating);
        updateStarDisplay(currentRating);
      });

      btn.addEventListener('mouseenter', () => {
        const rating = parseInt(btn.dataset.rating);
        updateStarDisplay(rating);
      });

      btn.addEventListener('mouseleave', () => {
        updateStarDisplay(currentRating);
      });
    });

    submitRating.addEventListener('click', () => {
      if (currentRating === 0) {
        showToast('Please select a rating');
        return;
      }

      // Save using RatingSystem
      RatingSystem.saveRating(`${novelData.id}_chapter_${chapterData.id}`, currentRating);

      ratingModal.classList.remove('open');
      showToast(`Thanks for rating! You gave ${currentRating} stars`);
    });

    // Add to Library using LibrarySystem
    const addToLibraryBtn = document.getElementById('addToLibraryBtn');

    function updateLibraryBtnUI() {
      const inLibrary = LibrarySystem.isInLibrary(novelData.id);
      if (inLibrary) {
        addToLibraryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
          In Library
        `;
        addToLibraryBtn.style.background = 'var(--primary)';
        addToLibraryBtn.style.borderColor = 'var(--primary)';
        addToLibraryBtn.style.color = '#fff';
      } else {
        addToLibraryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
          Add to Library
        `;
        addToLibraryBtn.style.background = '';
        addToLibraryBtn.style.borderColor = '';
        addToLibraryBtn.style.color = '';
      }
    }

    updateLibraryBtnUI();

    addToLibraryBtn.addEventListener('click', () => {
      const added = LibrarySystem.toggleLibrary(novelData.id, novelData);
      updateLibraryBtnUI();
      showToast(added ? 'Added to your library' : 'Removed from library');
    });

    // Chapter navigation - now uses URL navigation for Supabase chapters
    function navigateToChapter(newChapterId) {
      if (newChapterId < 1 || newChapterId > chapterData.totalChapters) {
        showToast(newChapterId < 1 ? 'This is the first chapter' : 'This is the last chapter');
        return;
      }

      // If we have Supabase chapters, navigate via URL
      if (allChapters.length > 0) {
        window.location.href = `reader.html?id=${novelId}&chapter=${newChapterId}`;
        return;
      }

      // Fallback to demo mode - update chapter data
      chapterData.id = newChapterId;
      chapterData.title = chapterTitles[newChapterId];

      // Update UI elements
      document.querySelector('.chapter-number').textContent = `Chapter ${newChapterId}`;
      document.querySelector('.chapter-title').textContent = chapterData.title;
      document.getElementById('chapterListBtn2').textContent = `Chapter ${newChapterId} of ${chapterData.totalChapters}`;

      // Update content
      const chapterContentEl = document.getElementById('chapterContent');
      chapterContentEl.innerHTML = chapterContents[newChapterId] || '<p>Chapter content loading...</p>';

      // Reset scroll and progress
      window.scrollTo(0, 0);
      progressFill.style.width = '0%';

      // Add to reading history
      ReadingHistory.addToHistory(novelData.id, chapterData.id, {
        title: novelData.title,
        chapterTitle: `Chapter ${newChapterId}: ${chapterData.title}`,
        cover: novelData.cover
      });

      // Mark chapter as read
      const readChapters = JSON.parse(localStorage.getItem(`read_chapters_${novelData.id}`) || '[]');
      if (!readChapters.includes(newChapterId)) {
        readChapters.push(newChapterId);
        localStorage.setItem(`read_chapters_${novelData.id}`, JSON.stringify(readChapters));

        // Sync library progress to Supabase
        (async () => {
          try {
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (user && novelData.id) {
              const isInLibrary = await SupabaseDB.isInLibrary(user.id, novelData.id);
              if (isInLibrary) {
                const highestRead = Math.max(...readChapters);
                await SupabaseDB.updateProgress(user.id, novelData.id, highestRead);
              }
            }
          } catch (error) {
            console.error('Error syncing library progress:', error);
          }
        })();
      }

      // Update button states
      updateNavButtonStates();

      showToast(`Chapter ${newChapterId}: ${chapterData.title}`);
    }

    function updateNavButtonStates() {
      const prevBtn = document.getElementById('prevChapterBtn');
      const nextBtn = document.getElementById('nextChapterBtn');

      // Disable/enable based on current chapter
      prevBtn.style.opacity = chapterData.id <= 1 ? '0.5' : '1';
      prevBtn.style.cursor = chapterData.id <= 1 ? 'not-allowed' : 'pointer';
      nextBtn.style.opacity = chapterData.id >= chapterData.totalChapters ? '0.5' : '1';
      nextBtn.style.cursor = chapterData.id >= chapterData.totalChapters ? 'not-allowed' : 'pointer';
    }

    // Initialize button states
    updateNavButtonStates();

    document.getElementById('prevChapterBtn').addEventListener('click', () => {
      navigateToChapter(chapterData.id - 1);
    });

    document.getElementById('nextChapterBtn').addEventListener('click', () => {
      navigateToChapter(chapterData.id + 1);
    });

    // Mark chapter as read in localStorage
    const readChapters = JSON.parse(localStorage.getItem(`read_chapters_${novelData.id}`) || '[]');
    if (!readChapters.includes(chapterData.id)) {
      readChapters.push(chapterData.id);
      localStorage.setItem(`read_chapters_${novelData.id}`, JSON.stringify(readChapters));
    }

    // Update library progress in Supabase if logged in
    async function syncLibraryProgress() {
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (user && novelData.id) {
          // Check if novel is in user's library
          const isInLibrary = await SupabaseDB.isInLibrary(user.id, novelData.id);
          if (isInLibrary) {
            // Update current chapter to the highest read
            const highestRead = Math.max(...readChapters);
            await SupabaseDB.updateProgress(user.id, novelData.id, highestRead);
          }
        }
      } catch (error) {
        console.error('Error syncing library progress:', error);
      }
    }
    syncLibraryProgress();

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        settingsPanel.classList.remove('open');
        chapterListPanel.classList.remove('open');
        ratingModal.classList.remove('open');
        panelOverlay.classList.remove('active');
      }

      // Arrow keys for navigation
      if (e.key === 'ArrowLeft') {
        document.getElementById('prevChapterBtn').click();
      } else if (e.key === 'ArrowRight') {
        document.getElementById('nextChapterBtn').click();
      }

      // B for bookmark
      if (e.key === 'b' || e.key === 'B') {
        bookmarkBtn.click();
      }
    });

    // ==================== Comments System ====================
    let currentUser = null;
    let comments = [];

    // Check authentication status for comments
    async function checkAuthForComments() {
      try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();
        currentUser = user;

        const loginPrompt = document.getElementById('commentLoginPrompt');
        const formContent = document.getElementById('commentFormContent');

        if (user) {
          loginPrompt.style.display = 'none';
          formContent.style.display = 'block';
        } else {
          loginPrompt.style.display = 'block';
          formContent.style.display = 'none';
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }

    // Load comments for this chapter
    async function loadComments() {
      const commentsList = document.getElementById('commentsList');
      const commentsCount = document.getElementById('commentsCount');

      if (!chapterData.dbId) {
        // No Supabase chapter loaded, show empty state
        commentsList.innerHTML = `
          <div class="comments-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <p>No comments yet. Be the first to share your thoughts!</p>
          </div>
        `;
        commentsCount.textContent = '0 comments';
        return;
      }

      try {
        const fetchedComments = await SupabaseDB.getComments(chapterData.dbId);
        comments = fetchedComments || [];

        commentsCount.textContent = `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;

        if (comments.length === 0) {
          commentsList.innerHTML = `
            <div class="comments-empty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
          `;
        } else {
          renderComments();
        }
      } catch (error) {
        console.error('Error loading comments:', error);
        commentsList.innerHTML = `
          <div class="comments-empty">
            <p>Unable to load comments. Please try again later.</p>
          </div>
        `;
      }
    }

    // Render comments list
    function renderComments() {
      const commentsList = document.getElementById('commentsList');

      const commentsHTML = comments.map(comment => {
        const authorName = comment.profiles?.display_name || comment.profiles?.username || 'Anonymous';
        const initial = authorName.charAt(0).toUpperCase();
        const date = new Date(comment.created_at).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const isOwner = currentUser && comment.user_id === currentUser.id;

        return `
          <div class="comment-item" data-comment-id="${comment.id}">
            <div class="comment-header">
              <div class="comment-author">
                <div class="comment-avatar">${initial}</div>
                <div class="comment-author-info">
                  <span class="comment-author-name">${escapeHtml(authorName)}</span>
                  <span class="comment-date">${date}</span>
                </div>
              </div>
              ${isOwner ? `
                <button class="comment-delete" onclick="deleteComment('${comment.id}')" title="Delete comment">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              ` : ''}
            </div>
            <div class="comment-content">${escapeHtml(comment.content)}</div>
          </div>
        `;
      }).join('');

      commentsList.innerHTML = commentsHTML;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Submit a new comment
    async function submitComment() {
      const input = document.getElementById('commentInput');
      const content = input.value.trim();
      const submitBtn = document.getElementById('submitComment');

      if (!content) {
        showToast('Please write a comment first');
        return;
      }

      if (!currentUser) {
        showToast('Please sign in to comment');
        return;
      }

      if (!chapterData.dbId) {
        showToast('Cannot post comment - chapter not loaded from database');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Posting...';

      try {
        const newComment = await SupabaseDB.addComment(
          currentUser.id,
          chapterData.dbId,
          novelData.id,
          content
        );

        // Add to local array and re-render
        comments.unshift(newComment);
        renderComments();

        // Update count
        document.getElementById('commentsCount').textContent =
          `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;

        // Clear input
        input.value = '';
        showToast('Comment posted!');
      } catch (error) {
        console.error('Error posting comment:', error);
        showToast('Failed to post comment. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Post Comment';
      }
    }

    // Delete a comment
    async function deleteComment(commentId) {
      if (!confirm('Are you sure you want to delete this comment?')) {
        return;
      }

      try {
        await SupabaseDB.deleteComment(commentId, currentUser.id);

        // Remove from local array
        comments = comments.filter(c => c.id !== commentId);
        renderComments();

        // Update count
        document.getElementById('commentsCount').textContent =
          `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;

        // Show empty state if no comments left
        if (comments.length === 0) {
          document.getElementById('commentsList').innerHTML = `
            <div class="comments-empty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
          `;
        }

        showToast('Comment deleted');
      } catch (error) {
        console.error('Error deleting comment:', error);
        showToast('Failed to delete comment');
      }
    }

    // Set up comment form submission
    document.getElementById('submitComment').addEventListener('click', submitComment);

    document.getElementById('commentInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        submitComment();
      }
    });

    // Real-time comments subscription
    let commentsSubscription = null;

    function subscribeToComments() {
      if (!chapterData.dbId || !window.supabaseClient) return;

      // Unsubscribe from previous channel if exists
      if (commentsSubscription) {
        commentsSubscription.unsubscribe();
      }

      // Subscribe to changes on comments table for this chapter
      commentsSubscription = window.supabaseClient
        .channel(`comments:${chapterData.dbId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'comments',
          filter: `chapter_id=eq.${chapterData.dbId}`
        }, async (payload) => {
          // A new comment was added - fetch it with profile info
          try {
            const { data: newComment } = await window.supabaseClient
              .from('comments')
              .select(`
                *,
                profiles (username, display_name, avatar_url)
              `)
              .eq('id', payload.new.id)
              .single();

            if (newComment && !comments.find(c => c.id === newComment.id)) {
              comments.unshift(newComment);
              renderComments();
              document.getElementById('commentsCount').textContent =
                `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;
            }
          } catch (error) {
            console.error('Error fetching new comment:', error);
          }
        })
        .on('postgres_changes', {
          event: 'DELETE',
          schema: 'public',
          table: 'comments',
          filter: `chapter_id=eq.${chapterData.dbId}`
        }, (payload) => {
          // A comment was deleted - remove it from local array
          comments = comments.filter(c => c.id !== payload.old.id);
          renderComments();
          document.getElementById('commentsCount').textContent =
            `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;
        })
        .subscribe();
    }

    // Initialize comments system after page load
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuthForComments();
      // Load comments after chapter data is loaded
      setTimeout(() => {
        loadComments();
        subscribeToComments();
      }, 500);
    });

    // Reload comments when chapter changes (for SPA-style navigation)
    window.addEventListener('chapterLoaded', () => {
      loadComments();
      subscribeToComments();
    });

    // Cleanup subscription when leaving page
    window.addEventListener('beforeunload', () => {
      if (commentsSubscription) {
        commentsSubscription.unsubscribe();
      }
    });
  </script>
</body>
</html>
